---
title: Layer raster (immagini)
day: 2
---
Come dicevamo nella precedente lezione, i layer di immagini si differenziano in base a come li vogliamo rappresentati (immagine intera o a tasselli) e alla sorgente da cui otteniamo le immagini stesse, che poi OL comporrà nella mappa. In questo capitolo vedremo i due tipi di layer + sorgenti più tipiche di un'applicazione WebGIS.

Sorgenti XYZ
============
Per sorgenti XYZ si intendono comunemente quei servizi che mettono a disposizione _tasselli_ di immagini (tiles), normalmente di dimensione quadrata 256 x 256 pixel, strutturati in base al livello di zoom e di coordinate X/Y dei taselli all'interno della griglia utilizzata per la loro generazione.

Esistono diversi modi di definire le coordinate griglia di una tile ma il sistema più comune è quello utilizzato ad da OSM, Mapbox, Google Maps, CartoDB, e molti altri provider globali, definito comunemente XYZ. Al primo livello di zoom (zoom = 0) la griglia è un unico tassello che copre l'estensione massima prevista per la proiezione EPSG:3857 (-180° < lon < 180°, -85.0511 < lat < 85.0511 <sup><a name="nota1">1</a></sup>). Al livello successivo (zoom = 1) i tasselli orizzontali e verticali diventano 2 x 2, e le loro coordinate sono quelle rappresentate secondo la modalità Google nella seguente immagine:

{% include image.html url="/assets/img/tiles_0.png" title="Zoom 1" caption="(immagine ottenuta da 'Tiles à la Google Maps' - Copyright © 2008 Klokan Petr Přidal)" %}

Ad ogni livello di zoom il numero di tasselli orizzontai e verticali aumenta con legge esponenziale 2^<sup>zoom -1</sup>, e così a zoom = 10 per l'area di Firenze otteniamo le seguenti coordinate X/Y

{% include image.html url="/assets/img/tiles_10.png" title="Zoom 1" caption="(immagine ottenuta da 'Tiles à la Google Maps' - Copyright © 2008 Klokan Petr Přidal)" %} 

Questi tre parametri, zoom e coordinate X/Y, sono sufficienti per ottenere l'immagine della tile d'interesse. Nel formato XYZ questo si traduce in una chiamata del tipo

```
https://a.tile.openstreetmap.org/Z/X/Y.png
```

Ad esempio per ottenere una delle tile dell'ultima immagine da OpenStreetMap Standard [https://a.tile.openstreetmap.org/10/544/373.png](https://a.tile.openstreetmap.org/10/544/373.png){:target="_blank"}, oppure da una mappa Mapbox [https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/10/544/373](https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/10/544/373?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY5YzJzczA2ejIzM29hNGQ3emFsMXgifQ.az9JUrQP7klCgD3W-ueILQ){:target="_blank"}

OpenLayers offre sia un tipo di sorgente generica `ol.source.XYZ`, che calcola le coordinate per la porzione di mappa visualizzata e le chiede al server indicato nella URL di configurazione, sia delle classi derivate e specializzate per alcuni dei servizi principali. Una di queste è quella usata già nel primo esempio `ol.source.OSM`.

Nel caso volessimo usare un layer Mapbox, magari creato con il proprio account, dovremo utilizzare direttamente `ol.source.XYZ`, perché non esiste una classe specifica per questo provider.

{% highlight javascript linenos %}
var map = new ol.Map({
  layers: [
    new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: 'https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=<token di accesso al layer>'
      })
    })
  ],
  target: 'map',
  view: new ol.View({
    center: [0, 0],
    zoom: 2
  })
});
{% endhighlight %}

Abbiamo istanziato un'immagine a tile, a cui abbiamo associato una sorgente XYZ. A riga 5 abbiamo configurato la sorgente con l'URL del servizio e inserendo i parametri _template_ {z}/{x}/{y} che via via OL sostituirà con i valori opportuni in pase a posizione e zoom della mappa.

Un altro formato abbastanza diffuso, sempre basato sulla tassellizzazione di una griglia di riferimento, è quello del protocollo **TMS** (Tiled Map Service). L'unica differenza sostanziale è l'inversione delle coordinate Y delle tile, secondo la formula **y = (2^z) - y - 1**. 

Per facilitare l'uso di questo formato OpenLayers permette di inserire il carattere `-` nel parametro template e in quel caso il suo valore sarà invertito automaticamente, per cui per poter usare un servizio TMS sfruttendo `ol.layer.XYZ` dovremo usare un template con le y invertite: `{-y}`.

Infine citiamo il protocollo **[OGC WMTS](http://www.opengeospatial.org/standards/wmts){:target="_blank"}**, meno frequente ma importante in quanto standard ufficiale, per il quale OL offre la sorgente `ol.source.WMTS`.

Sorgenti WMS
============

<span style="font-size:0.85em">&#91;[1](nota1)&#93; Derivato da arctan(sinh(π)), in modo che la terra rientri perfettamente in un quadrato.</span>